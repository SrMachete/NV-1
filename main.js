let asociados=JSON.parse(localStorage.getItem('asociados')||'[]');let asignaciones=JSON.parse(localStorage.getItem('asignaciones')||'{}');let currentDate=new Date();const cal=document.getElementById('calendar');const monthYear=document.getElementById('monthYear');function renderCal(){cal.innerHTML='';const y=currentDate.getFullYear(),m=currentDate.getMonth();monthYear.textContent=currentDate.toLocaleString('es-MX',{month:'long',year:'numeric'});const fd=new Date(y,m,1).getDay();const dim=new Date(y,m+1,0).getDate();for(let i=0;i<fd;i++) cal.appendChild(document.createElement('div'));for(let d=1;d<=dim;d++){const k=y+'-'+(m+1)+'-'+d;const cell=document.createElement('div');cell.className='day-cell';cell.textContent=d;const assigns=asignaciones[k]||[];if(assigns.length>0) cell.classList.add('assigned');const dockCount=assigns.filter(a=>a.procesos.includes('Dock')).length;if(dockCount>=5){cell.classList.remove('assigned');cell.classList.add('alert');}cell.onclick=()=>showPopup(k);cal.appendChild(cell);}}function showPopup(k){document.getElementById('popup').classList.remove('hidden');document.getElementById('popupDate').textContent=k;const ul=document.getElementById('assignedList');ul.innerHTML='';(asignaciones[k]||[]).forEach(a=>{const li=document.createElement('li');li.textContent=a.login+' ('+a.turno+') '+a.procesos.join(',');const b=document.createElement('button');b.textContent='Quitar';b.onclick=()=>{asignaciones[k]=asignaciones[k].filter(x=>x.login!==a.login);save();renderCal();showPopup(k)};li.appendChild(b);ul.appendChild(li)});const sel=document.getElementById('selectAssociate');sel.innerHTML='';asociados.forEach(a=>{if(!(asignaciones[k]||[]).some(x=>x.login===a.login)){const o=document.createElement('option');o.value=a.login;o.textContent=a.login;sel.appendChild(o)}});document.getElementById('addAssociateBtn').onclick=()=>{const login=sel.value;if(!login)return;const a=asociados.find(x=>x.login===login);asignaciones[k]=asignaciones[k]||[];asignaciones[k].push(a);save();renderCal();showPopup(k)};}document.getElementById('closeBtn').onclick=()=>document.getElementById('popup').classList.add('hidden');document.getElementById('prevMonth').onclick=()=>{currentDate.setMonth(currentDate.getMonth()-1);renderCal()};document.getElementById('nextMonth').onclick=()=>{currentDate.setMonth(currentDate.getMonth()+1);renderCal()};function save(){localStorage.setItem('asociados',JSON.stringify(asociados));localStorage.setItem('asignaciones',JSON.stringify(asignaciones))}const form=document.getElementById('associateForm');const turnoSel=document.getElementById('turnoSelect');['DC','DR','DB','D5','DX','DI','DJ','DH'].forEach(t=>{let o=document.createElement('option');o.value=t;o.textContent=t;turnoSel.appendChild(o)});const procDiv=document.getElementById('procesosChecks');['Pick','Pit','Pack','Rebin','Dock','Capitan','Trans','Cargas','TDR','Delibery','PCNS','Auditor','Sort'].forEach(p=>{let l=document.createElement('label');l.innerHTML='<input type=checkbox value='+p+'> '+p;procDiv.appendChild(l)});form.onsubmit=e=>{e.preventDefault();const login=document.getElementById('loginInput').value;const turno=turnoSel.value;const procesos=[...procDiv.querySelectorAll('input:checked')].map(x=>x.value);if(!login||!turno||procesos.length==0)return;if(asociados.some(a=>a.login===login)){alert('Ya existe');return;}asociados.push({login,turno,procesos});save();renderAssocList();form.reset()};function renderAssocList(){const ul=document.getElementById('assocList');ul.innerHTML='';asociados.forEach(a=>{const li=document.createElement('li');li.textContent=a.login+' ('+a.turno+') '+a.procesos.join(',');const b=document.createElement('button');b.textContent='Eliminar';b.onclick=()=>{asociados=asociados.filter(x=>x.login!==a.login);for(const k in asignaciones){asignaciones[k]=asignaciones[k].filter(x=>x.login!==a.login);}save();renderCal();renderAssocList()};li.appendChild(b);ul.appendChild(li)});}document.getElementById('btnManage').onclick=()=>document.getElementById('managePanel').classList.toggle('hidden');window.onload=()=>{renderCal();renderAssocList()}